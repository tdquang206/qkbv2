{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Manage Drugs</h1>

    <!-- Button to trigger modal -->
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addDrugModal">
        Add New Drug
    </button>

    <!-- Import from json -->
    <!-- <button onclick="importDrugs()" class="btn btn-secondary mb-3 ms-2">
        Import Drugs from JSON
    </button>
    
    <div class="upload-container mb-3">
        <div class="drop-zone border rounded p-4 text-center" id="dropZone">
            <p>Drag & drop JSON file here or</p>
            <input type="file" id="fileInput" accept=".json" class="d-none">
            <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>
        <div id="filePreview" class="mt-2"></div>
    </div> -->

    <!-- Include your existing modal -->
    {% include "_modal_add_new_drug.html" %}


    <!-- Search -->
    <div class="mb-3">
        <input type="text" class="form-control" placeholder="Search by name or SKU" id="searchInput"
            onkeyup="filterTable()">
    </div>

    <!-- Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle" id="drugTable">
            <thead class="table-dark">
                <tr>
                    <th class="d-none">ID</th>
                    <th class="d-none">SKU</th>
                    <th>Name</th>
                    <th>Sell Price</th>
                    <th>Buy Price</th>

                    <th>Inventory</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for drug in drugs %}
                <tr>
                    <td class="d-none">{{ drug.id }}</td>
                    <td class="d-none">{{ drug.drug_sku }}</td>
                    <td>{{ drug.drug_name }}</td>
                    <td>{{ drug.drug_sell_price }}</td>
                    <td>{{ drug.drug_purchase_price }}</td>

                    <td>{{ drug.drug_stock }}</td>
                    <td>
                        <a href="/drugs_list/edit/{{ drug.id }}" class="btn btn-sm btn-info text-white">Edit /
                            Delte</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Filter table by SKU or Name
    function filterTable() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#drugTable tbody tr");
        rows.forEach(row => {
            const sku = row.cells[1].textContent.toLowerCase();
            const name = row.cells[2].textContent.toLowerCase();
            row.style.display = sku.includes(input) || name.includes(input) ? "" : "none";
        });
    }
</script>

<!-- should delete after import -->
<script>
    function handleFileUpload(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const jsonData = JSON.parse(e.target.result);
                if (!Array.isArray(jsonData)) {
                    throw new Error("check JSON")
                }
                const preview = document.getElementById('filePreview');
                preview.innerHTML = `
                    <div class="alert alert-info">
                        <strong>File contents:</strong><br>
                        Found ${jsonData.length} drug records<br>
                        <button class="btn btn-sm btn-success mt-2" onclick='importJsonData(${JSON.stringify(jsonData)})'>
                        Import Data
                        </button>
                    </div>
                    `;
            } catch (error) {
                document.getElementById('filePreview').innerHTML = `
                    <div class="alert alert-danger">
                        Invalid JSON file format
                    </div>
                `;
            }
        };
        reader.readAsText(file);
    }

    // Set up drag and drop handlers
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-primary');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary');
        const file = e.dataTransfer.files[0];
        if (file.type === 'application/json') {
            handleFileUpload(file);
        } else {
            document.getElementById('filePreview').innerHTML = `
                <div class="alert alert-danger">
                    Please upload a JSON file
                </div>
            `;
        }
    });

    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file.name.endsWith('.json')) {
            handleFileUpload(file);
        }
    });

    async function importJsonData(jsonData) {
        const normalized = jsonData.map(d => ({
            ...d,
            drug_sell_price: d.drug_sell_price ? parseFloat(d.drug_sell_price) : null,
            drug_purchase_price: d.drug_purchase_price ? parseFloat(d.drug_purchase_price) : null,
            drug_stock: d.drug_stock ? parseInt(d.drug_stock) : null
        }));
        try {
            const response = await fetch('/import-drugs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(normalized)
            });
            const result = await response.json();
            alert(result.message);
            location.reload();
        } catch (error) {
            alert('Error importing data');
        }
    }
</script>

<!-- Add this to your base.html or drugs_list.html in the <style> section -->
<style>
    .drop-zone {
        border: 2px dashed #ccc !important;
        transition: border 0.3s ease;
        cursor: pointer;
    }

    .drop-zone.border-primary {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.05);
    }
</style>
{% endblock %}